<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits | 1nc1n3r470r's website</title><meta name=keywords content><meta name=description content="In this series im going over the opensource project called braxme. This post is about the coding style of braxme and some trivial security holes I found. The source code can be found on github.com.
Coding style That brings me to the first big problem i have with braxme: The coding style. There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, &mldr;"><meta name=author content><link rel=canonical href=https://1nc1n3r470r.github.io/posts/braxme-readthrough/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://1nc1n3r470r.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://1nc1n3r470r.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://1nc1n3r470r.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://1nc1n3r470r.github.io/apple-touch-icon.png><link rel=mask-icon href=https://1nc1n3r470r.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits"><meta property="og:description" content="In this series im going over the opensource project called braxme. This post is about the coding style of braxme and some trivial security holes I found. The source code can be found on github.com.
Coding style That brings me to the first big problem i have with braxme: The coding style. There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, &mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://1nc1n3r470r.github.io/posts/braxme-readthrough/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits"><meta name=twitter:description content="In this series im going over the opensource project called braxme. This post is about the coding style of braxme and some trivial security holes I found. The source code can be found on github.com.
Coding style That brings me to the first big problem i have with braxme: The coding style. There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, &mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://1nc1n3r470r.github.io/posts/"},{"@type":"ListItem","position":2,"name":"BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits","item":"https://1nc1n3r470r.github.io/posts/braxme-readthrough/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits","name":"BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits","description":"In this series im going over the opensource project called braxme. This post is about the coding style of braxme and some trivial security holes I found. The source code can be found on github.com.\nCoding style That brings me to the first big problem i have with braxme: The coding style. There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, \u0026hellip;","keywords":[],"articleBody":"In this series im going over the opensource project called braxme. This post is about the coding style of braxme and some trivial security holes I found. The source code can be found on github.com.\nCoding style That brings me to the first big problem i have with braxme: The coding style. There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, …\nBut lets not get ahead of ourselves and carefully dissect the problems with an example.\nExample im using this example. Im going through all the code for transparency.\nini_set('session.cookie_httponly', 1); ini_set('session.use_only_cookies', 1); session_start(); Ok, so the project uses php sessions with cookies. However: because security relevant ini variables didnt get set globally and only on a file to file basis and attacker could bypass the httponly if they find a public file that calls session_start()\twithout the httponly flag. Im not 100% certain that you can bypass httponly that way so i’ll have to research further before making any final conclusions.\nThe httponly flag also does NOT protect you from csrf so you would need a csrf protection to protect yourself from malicious embedding.\n/* INSTALLFOLDER IS HARDCODED HERE */ require_once(\"prod/config.php\"); Ummmm….\nWhere is that file? It seems to not exist.\n$s = ''; $gcm = ''; $apn = ''; $uuid = ''; $l = ''; $e = ''; $a = \"\"; $h = \"\"; $store = \"\"; $v = \"\"; $action = \"\"; $l = @mysql_safe_string($_GET['l']); $e = @mysql_safe_string($_GET['e']); $s = @mysql_safe_string($_GET['s']); $gcm = @mysql_safe_string($_GET['gcm']); $apn = @mysql_safe_string($_GET['apn']); $a = @mysql_safe_string($_GET['a']); $h = @mysql_safe_string($_GET['h']); $v = @mysql_safe_string($_GET['v']); $store = @mysql_safe_string($_GET['store']); $uuid = \"\"; This causes me physical pain and is called code smell. 11 variables without ANY explanaition whatsoever; lets go through it anyway and document their use.\nvariables that do nothing (Dead code):\n$l $e $uuid with that out of the way, lets go through the other variables and explain them:\n$a is an action that you set (for example $a = logout logs you out) $s gets added to $source $gcm gets added to $source if its non-empty $apn behaves exactly like $gcm $a can be set to “logout” which causes the client to set localStorage.pid = '';. $h gets added to $source as well $store same with $h $v gets injected into JS (DANGEROUS) if($a=='logout'){ $action=\"\"; } if($s==''){ $source=\"?s=nonmobile\u0026h=$h\"; } else { if($v == ''){ $v = \"000\"; } if($gcm!=''){ $source=\"?s=$s\u0026gcm=$gcm\u0026h=$h\u0026store=$store\u0026v=\"; } else if($apn!=''){ $source=\"?s=$s\u0026apn=$apn\u0026h=$h\u0026store=$store\u0026v=\"; } else { $source=\"?s=$s\u0026h=$h\u0026store=$store\u0026v=\"; } } This part is explained above: some variables get concatenated to others.\n$login = \"login.php\".$source; Dead code AGAIN! The $login variable does not do ANYTHING\n\u003chtml\u003e \u003chead\u003e \u003ctitle\u003eBrax.Me\u003c/title\u003e \u003cMETA HTTP-EQUIV='Pragma' CONTENT='no-cache'\u003e \u003cMETA HTTP-EQUIV='Expires' CONTENT='-1'\u003e \u003cmeta name='viewport' content='width=device-width, height=device-height, initial-scale=1, user-scalable=0, maximum-scale=1'\u003e \u003clink rel='icon' href='https://brax.me/img/favicon.ico' type='image/x-icon'\u003e \u003clink rel='shortcut icon' href='https://brax.me/img/favicon.ico' type='image/x-icon'\u003e \u003clink rel='apple-touch-icon' href='https://brax.me/img/lock2.png'\u003e \u003clink rel='stylesheet' href='$rootserver/libs/jquery-1.11.1/jquery-ui.css'\u003e \u003cscript src='\u003c?=$rootserver?\u003e/libs/jquery-1.11.1/jquery.min.js' \u003e\u003c/script\u003e \u003cscript src='\u003c?=$rootserver?\u003e/libs/jquery-1.11.1/jquery-ui.js' \u003e\u003c/script\u003e \u003cmeta name=\"description\" content=\"Brax.Me - Private Communities\"\u003e html skeleton code\nYou might have realized at first glance that a mysterious php variable called $rootserver suddenly appeared. I dont know where it comes from but it seems to be a config.php variable. Its bad codestyle either way for following reasons:\nit doesnt get used consistently. Sometimes https://brax.me is prepended, sometimes its $rootserver. its unneded. Relative paths are way more robust and make your code more portable and readable. What seems to lack in general are templates. I dont want to get into too much detail as this is offtopic but it would greatly increase the code and security quality if the copypasta is replaced by an actual robust template.\n\u003c?=$action?\u003e Why? the $action is completely unnecesary and makes the code much harder to read. As explained above the $action is either a fixed string or empty. An if could have solved this string mess.\n\u003c/head\u003e \u003cbody style='background-color:whitesmoke;color:black'\u003e Loading... \u003cscript\u003e start of the body (i analyze the javascript seperately)\nHere are two things wrong:\nThe CSS is inside the html is in my opinion a bad coding style though that can be debated. Commented out code should be deleted (this is called code smell as it rots and drags down your codebase) var rootserver1 = '\u003c?=$rootserver?\u003e'; var login = '\u003c?=$source?\u003e'; if('\u003c?=$v?\u003e'!=='000' \u0026\u0026 '\u003c?=$v?\u003e'!==''){ localStorage.mobileversion = '\u003c?=$v?\u003e'; //alert(localStorage.mobileversion); } vlocation = rootserver1+\"/prod/login.php\"+login+localStorage.mobileversion; //alert(vlocation); window.location = vlocation; First lets talk about the code again then the implications. The snippet again shows some codesmell:\nmagic numbers commented out code The code does NOT sanitize ANY attacker controlled input, so lets analyze what exploits you can build. This is where things get interesting…\nFirst exploit if i control $rootserver, $source or $v i can inject arbitrary JS. All i need is to escape the ’ string in JS.\nTrivial XSS Lets go through a step by step example of such a XSS attack. Anyone familiar with XSS attacks can probably skip this part.\nHere is an example:\nl.php?h=%27;alert(%22XSS%22);// How it works We know from above that only setting $h will execute following part of the code:\n$source=\"?s=nonmobile\u0026h=$h\"; [removed unnecesary code]\nvar login = '\u003c?=$source?\u003e'; Now the PHP interpreter sets $source to the value from above:\nvar login = '?s=nonmobile\u0026h=';alert(\"XSS\");//'; That is beautified:\nvar login = '?s=nonmobile\u0026h='; alert(\"XSS\"); // '; As I previously stated that attack is pretty trivial and should not happen to a seasoned programmer.\nConclusion TL;DR: the Code contains dead code, copypasted code, … and other atrocities that no seasoned programmer should EVER do. The code is also HIGHLY insecure and should be considered amateur work at best. The commented out code reminds me more of my friends code when he started coding than anything I consider production ready, so I highly advise you to NOT use this code in production.\n","wordCount":"965","inLanguage":"en","datePublished":"2022-10-11T00:00:00Z","dateModified":"2022-10-11T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://1nc1n3r470r.github.io/posts/braxme-readthrough/"},"publisher":{"@type":"Organization","name":"1nc1n3r470r's website","logo":{"@type":"ImageObject","url":"https://1nc1n3r470r.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://1nc1n3r470r.github.io/ accesskey=h title="1nc1n3r470r's website (Alt + H)">1nc1n3r470r's website</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>BraxMe Deep Dive Part 1: Bad Coding Style and first Exploits</h1><div class=post-meta><span title='2022-10-11 00:00:00 +0000 UTC'>October 11, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#coding-style aria-label="Coding style">Coding style</a><ul><li><a href=#example aria-label=Example>Example</a></li></ul></li><li><a href=#first-exploit aria-label="First exploit">First exploit</a><ul><li><a href=#trivial-xss aria-label="Trivial XSS">Trivial XSS</a><ul><li><a href=#how-it-works aria-label="How it works">How it works</a></li></ul></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>In this series im going over the opensource project called braxme.
This post is about the coding style of braxme and some trivial security holes I found.
The source code can be found on <a href=https://github.com/robbraxman/braxme>github.com</a>.</p><h1 id=coding-style>Coding style<a hidden class=anchor aria-hidden=true href=#coding-style>#</a></h1><p>That brings me to the first big problem i have with braxme: The coding style.
There is no inherent structure, project wide or only in a single file. There are also barely any comments, variable names get thrown all over the place, user input doesnt get sanitized properly, &mldr;</p><p>But lets not get ahead of ourselves and carefully dissect the problems with an example.</p><h2 id=example>Example<a hidden class=anchor aria-hidden=true href=#example>#</a></h2><p>im using this <a href=https://github.com/robbraxman/braxme/blob/3c814ebf7fec0a3ad972251f667bac6ceb511c97/l.php>example</a>. Im going through all the code for transparency.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>ini_set</span>(<span style=color:#e6db74>&#39;session.cookie_httponly&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>ini_set</span>(<span style=color:#e6db74>&#39;session.use_only_cookies&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>session_start</span>();    
</span></span></code></pre></div><p>Ok, so the project uses php sessions with cookies. However: because security relevant ini variables didnt get set globally and only on a file to file basis and attacker could bypass the httponly if <a href=https://github.com/robbraxman/braxme/blob/3c814ebf7fec0a3ad972251f667bac6ceb511c97/prod/photoupload1st.php>they find a public file that calls <code>session_start()</code> without the httponly flag</a>.
<strong><em>Im not 100% certain that you can bypass httponly that way so i&rsquo;ll have to research further before making any final conclusions</em></strong>.</p><p>The httponly flag also does NOT protect you from csrf so you would need a csrf protection to protect yourself from malicious embedding.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>/* INSTALLFOLDER IS HARDCODED HERE */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>require_once</span>(<span style=color:#e6db74>&#34;prod/config.php&#34;</span>);
</span></span></code></pre></div><p>Ummmm&mldr;.</p><p>Where is that file? <a href=https://github.com/robbraxman/braxme/blob/3c814ebf7fec0a3ad972251f667bac6ceb511c97/prod/config.php>It seems to not exist</a>.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$gcm <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$apn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$uuid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$l <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$e <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>$a <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>$h <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>$store <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>$v <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>$action <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$l <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;l&#39;</span>]);
</span></span><span style=display:flex><span>$e <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;e&#39;</span>]);
</span></span><span style=display:flex><span>$s <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;s&#39;</span>]);
</span></span><span style=display:flex><span>$gcm <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;gcm&#39;</span>]);
</span></span><span style=display:flex><span>$apn <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;apn&#39;</span>]);
</span></span><span style=display:flex><span>$a <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;a&#39;</span>]);
</span></span><span style=display:flex><span>$h <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;h&#39;</span>]);
</span></span><span style=display:flex><span>$v <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;v&#39;</span>]);
</span></span><span style=display:flex><span>$store <span style=color:#f92672>=</span> <span style=color:#f92672>@</span><span style=color:#a6e22e>mysql_safe_string</span>($_GET[<span style=color:#e6db74>&#39;store&#39;</span>]);
</span></span><span style=display:flex><span>$uuid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span></code></pre></div><p>This causes me physical pain and is called <a href=https://en.wikipedia.org/wiki/Code_smell>code smell</a>. 11 variables without ANY explanaition whatsoever; lets go through it anyway and document their use.</p><p>variables that do nothing (Dead code):</p><ul><li><code>$l</code></li><li><code>$e</code></li><li><code>$uuid</code></li></ul><p>with that out of the way, lets go through the other variables and explain them:</p><ul><li><code>$a</code> is an action that you set (for example <code>$a = logout</code> logs you out)</li><li><code>$s</code> gets added to <code>$source</code></li><li><code>$gcm</code> gets added to <code>$source</code> if its non-empty</li><li><code>$apn</code> behaves exactly like <code>$gcm</code></li><li><code>$a</code> can be set to &ldquo;logout&rdquo; which causes the client to set <code>localStorage.pid = '';</code>.</li><li><code>$h</code> gets added to <code>$source</code> as well</li><li><code>$store</code> same with <code>$h</code></li><li><code>$v</code> gets injected into JS (DANGEROUS)</li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span>($a<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;logout&#39;</span>){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $action<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;script&gt;localStorage.pid = &#39;&#39;;&lt;/script&gt;&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>($s<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;&#39;</span>){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;?s=nonmobile&amp;h=</span><span style=color:#e6db74>$h</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>($v <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>){
</span></span><span style=display:flex><span>        $v <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;000&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>($gcm<span style=color:#f92672>!=</span><span style=color:#e6db74>&#39;&#39;</span>){
</span></span><span style=display:flex><span>        $source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;?s=</span><span style=color:#e6db74>$s</span><span style=color:#e6db74>&amp;gcm=</span><span style=color:#e6db74>$gcm</span><span style=color:#e6db74>&amp;h=</span><span style=color:#e6db74>$h</span><span style=color:#e6db74>&amp;store=</span><span style=color:#e6db74>$store</span><span style=color:#e6db74>&amp;v=&#34;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>($apn<span style=color:#f92672>!=</span><span style=color:#e6db74>&#39;&#39;</span>){
</span></span><span style=display:flex><span>        $source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;?s=</span><span style=color:#e6db74>$s</span><span style=color:#e6db74>&amp;apn=</span><span style=color:#e6db74>$apn</span><span style=color:#e6db74>&amp;h=</span><span style=color:#e6db74>$h</span><span style=color:#e6db74>&amp;store=</span><span style=color:#e6db74>$store</span><span style=color:#e6db74>&amp;v=&#34;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        $source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;?s=</span><span style=color:#e6db74>$s</span><span style=color:#e6db74>&amp;h=</span><span style=color:#e6db74>$h</span><span style=color:#e6db74>&amp;store=</span><span style=color:#e6db74>$store</span><span style=color:#e6db74>&amp;v=&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This part is explained above: some variables get concatenated to others.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$login <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login.php&#34;</span><span style=color:#f92672>.</span>$source;
</span></span></code></pre></div><p>Dead code AGAIN! The <code>$login</code> variable does not do ANYTHING</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>title</span>&gt;Brax.Me&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>META</span> <span style=color:#a6e22e>HTTP-EQUIV</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Pragma&#39;</span> <span style=color:#a6e22e>CONTENT</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;no-cache&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>META</span> <span style=color:#a6e22e>HTTP-EQUIV</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Expires&#39;</span> <span style=color:#a6e22e>CONTENT</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-1&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;viewport&#39;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;width=device-width, height=device-height, initial-scale=1, user-scalable=0, maximum-scale=1&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;icon&#39;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://brax.me/img/favicon.ico&#39;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;image/x-icon&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;shortcut icon&#39;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://brax.me/img/favicon.ico&#39;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;image/x-icon&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;apple-touch-icon&#39;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://brax.me/img/lock2.png&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;stylesheet&#39;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;$rootserver/libs/jquery-1.11.1/jquery-ui.css&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;?=$rootserver?&gt;/libs/jquery-1.11.1/jquery.min.js&#39;</span> &gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;?=$rootserver?&gt;/libs/jquery-1.11.1/jquery-ui.js&#39;</span> &gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;description&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Brax.Me - Private Communities&#34;</span>&gt;     
</span></span></code></pre></div><p>html skeleton code</p><p>You might have realized at first glance that a mysterious php variable called <code>$rootserver</code> suddenly appeared. I dont know where it comes from but it seems to be a config.php variable. Its bad codestyle either way for following reasons:</p><ol><li>it doesnt get used consistently. Sometimes <code>https://brax.me</code> is prepended, sometimes its <code>$rootserver</code>.</li><li>its unneded. Relative paths are way more robust and make your code more portable and readable.</li></ol><p>What seems to lack in general are templates. I dont want to get into too much detail as this is offtopic but it would greatly increase the code and security quality if the copypasta is replaced by an actual robust template.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?=</span>$action<span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Why? the <code>$action</code> is completely unnecesary and makes the code much harder to read. As explained above the <code>$action</code> is either a fixed string or empty. An if could have solved this string mess.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>  &lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>body</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;background-color:whitesmoke;color:black&#39;</span>&gt;
</span></span><span style=display:flex><span>      Loading...
</span></span><span style=display:flex><span>      <span style=color:#75715e>&lt;!--
</span></span></span><span style=display:flex><span><span style=color:#75715e>      &lt;a href=&#39;&#39;&gt;Start &lt;/a&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>      --&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>start of the body (i analyze the javascript seperately)</p><p>Here are two things wrong:</p><ol><li>The CSS is inside the html is in my opinion a bad coding style though that can be debated.</li><li>Commented out code should be deleted (this is called <a href=https://softwareengineering.stackexchange.com/questions/190096/can-commented-out-code-be-valuable-documentation>code smell</a> as it rots and drags down your codebase)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rootserver1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;?=$rootserver?&gt;&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;?=$source?&gt;&#39;</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#39;&lt;?=$v?&gt;&#39;</span><span style=color:#f92672>!==</span><span style=color:#e6db74>&#39;000&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#39;&lt;?=$v?&gt;&#39;</span><span style=color:#f92672>!==</span><span style=color:#e6db74>&#39;&#39;</span>){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>localStorage</span>.<span style=color:#a6e22e>mobileversion</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;?=$v?&gt;&#39;</span>;
</span></span><span style=display:flex><span>            <span style=color:#75715e>//alert(localStorage.mobileversion);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vlocation</span> <span style=color:#f92672>=</span>  <span style=color:#a6e22e>rootserver1</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/prod/login.php&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>login</span><span style=color:#f92672>+</span><span style=color:#a6e22e>localStorage</span>.<span style=color:#a6e22e>mobileversion</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>//alert(vlocation);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        window.<span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>vlocation</span>;
</span></span></code></pre></div><hr><p>First lets talk about the code again then the implications.
The snippet again shows some codesmell:</p><ol><li>magic numbers</li><li>commented out code</li></ol><p>The code does NOT sanitize ANY attacker controlled input, so lets analyze what exploits you can build.
This is where things get interesting&mldr;</p><h1 id=first-exploit>First exploit<a hidden class=anchor aria-hidden=true href=#first-exploit>#</a></h1><p>if i control <code>$rootserver</code>, <code>$source</code> or <code>$v</code> i can inject arbitrary JS. All i need is to escape the &rsquo; string in JS.</p><h2 id=trivial-xss>Trivial XSS<a hidden class=anchor aria-hidden=true href=#trivial-xss>#</a></h2><p>Lets go through a step by step example of such a XSS attack. Anyone familiar with XSS attacks can probably skip this part.</p><p>Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>php</span><span style=color:#f92672>?</span><span style=color:#a6e22e>h</span><span style=color:#f92672>=%</span><span style=color:#ae81ff>27</span>;<span style=color:#a6e22e>alert</span>(<span style=color:#f92672>%</span><span style=color:#ae81ff>22</span><span style=color:#a6e22e>XSS</span><span style=color:#f92672>%</span><span style=color:#ae81ff>22</span>);<span style=color:#75715e>//
</span></span></span></code></pre></div><h3 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h3><p>We know from above that only setting $h will execute following part of the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>    $source<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;?s=nonmobile&amp;h=</span><span style=color:#e6db74>$h</span><span style=color:#e6db74>&#34;</span>;
</span></span></code></pre></div><p>[removed unnecesary code]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;?=$source?&gt;&#39;</span>;
</span></span></code></pre></div><p>Now the PHP interpreter sets $source to the value from above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;?s=nonmobile&amp;h=&#39;</span>;<span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#34;XSS&#34;</span>);<span style=color:#75715e>//&#39;;
</span></span></span></code></pre></div><p>That is beautified:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;?s=nonmobile&amp;h=&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#34;XSS&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// &#39;;
</span></span></span></code></pre></div><p>As I previously stated that attack is pretty trivial and should not happen to a seasoned programmer.</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>TL;DR: the Code contains dead code, copypasted code, &mldr; and other atrocities that no seasoned programmer should EVER do. The code is also <strong>HIGHLY</strong> insecure and should be considered amateur work at best. The commented out code reminds me more of my friends code when he started coding than anything I consider production ready, so I highly advise you to NOT use this code in production.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://1nc1n3r470r.github.io/>1nc1n3r470r's website</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>